<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ccr.mapper.TeacherManagementMapper">

    <resultMap id="CollegeMajorClassResultMap" type="com.ccr.vo.CollegeMajorClassVO">
        <id column="college_id" property="id"/>
        <result column="college_name" property="name"/>
        <result column="college_code" property="code"/>
    </resultMap>

    <resultMap id="MajorResultMap" type="com.ccr.vo.MajorVO">
        <id column="major_id" property="id"/>
        <result column="major_name" property="name"/>
        <result column="major_code" property="code"/>
    </resultMap>

    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        insert into user (username, password, real_name, phone, email, gender, status, user_type, create_time, update_time,create_user, update_user)
        values (#{username}, #{password}, #{realName}, #{phone}, #{email}, #{gender}, #{status}, #{userType}, #{createTime}, #{updateTime},#{createUser},#{updateUser})
    </insert>

    <insert id="insertTeacher">
        insert into teacher (user_id, teacher_no, college_id, major_id, title, hire_date, status, create_time, update_time, create_user, update_user)
        values (#{userId}, #{teacherNo}, #{collegeId}, #{majorId}, #{title}, #{hireDate}, #{status}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser})
    </insert>

    <update id="updateUser">
        update user
        <set>
            <if test="password != null">password = #{password},</if>
            <if test="realName != null">real_name = #{realName},</if>
            <if test="phone != null">phone = #{phone},</if>
            <if test="email != null">email = #{email},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateUser != null">update_user = #{updateUser},</if>
        </set>
        where id = #{id} and user_type = 2 and is_deleted = 0
    </update>

    <update id="updateTeacher">
        update teacher
        <set>
            <if test="teacherNo != null">teacher_no = #{teacherNo},</if>
            <if test="collegeId != null">college_id = #{collegeId},</if>
            <if test="majorId != null">major_id = #{majorId},</if>
            <if test="title != null">title = #{title},</if>
            <if test="hireDate != null">hire_date = #{hireDate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateUser != null">update_user = #{updateUser},</if>
        </set>
        where user_id = #{userId} and is_deleted = 0
    </update>

    <update id="deleteUser">
        update user
        set is_deleted = 1
        where id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
        and user_type = 2
    </update>

    <update id="deleteTeacher">
        update teacher
        set is_deleted = 1
        where user_id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

    <select id="getCollegeMajor" resultMap="CollegeMajorClassResultMap">
        SELECT DISTINCT
        c.id AS college_id,
        c.name AS college_name,
        c.code AS college_code
        FROM college c
        LEFT JOIN major m ON c.id = m.college_id AND m.is_deleted = 0
        LEFT JOIN class cl ON m.id = cl.major_id AND cl.is_deleted = 0
        <where>
            c.is_deleted = 0
            <if test="collegeName != null and collegeName != ''">AND c.name LIKE CONCAT('%', #{collegeName}, '%')</if>
            <if test="collegeCode != null and collegeCode != ''">AND c.code LIKE CONCAT('%', #{collegeCode}, '%')</if>
            <if test="majorName != null and majorName != ''">AND m.name LIKE CONCAT('%', #{majorName}, '%')</if>
            <if test="majorCode != null and majorCode != ''">AND m.code LIKE CONCAT('%', #{majorCode}, '%')</if>
        </where>
        ORDER BY c.id
    </select>

    <select id="getMajorsByCollegeId" resultMap="MajorResultMap">
        SELECT DISTINCT
        m.id AS major_id,
        m.name AS major_name,
        m.code AS major_code
        FROM major m
        LEFT JOIN class cl ON m.id = cl.major_id AND cl.is_deleted = 0
        <where>
            m.college_id = #{collegeId}
            AND m.is_deleted = 0
            <if test="majorName != null and majorName != ''">AND m.name LIKE CONCAT('%', #{majorName}, '%')</if>
            <if test="majorCode != null and majorCode != ''">AND m.code LIKE CONCAT('%', #{majorCode}, '%')</if>
        </where>
        ORDER BY m.id
    </select>

    <select id="selectByUsername" resultType="com.ccr.entity.User">
        select id,username from user where username = #{username} and is_deleted = 0 and user_type = 2
    </select>

    <select id="listTeacherAccount" resultType="com.ccr.vo.UserWithTeacherInfoPageVO">
        select u.id,u.username,u.real_name,u.phone,u.email,u.status,t.teacher_no,t.title
        from user u left join teacher t on u.id = t.user_id
        <where>
            <if test="username != null and username != ''">AND u.username LIKE CONCAT('%', #{username}, '%')</if>
            <if test="realName != null and realName != ''">AND u.real_name LIKE CONCAT('%', #{realName}, '%')</if>
            <if test="teacherNo != null and teacherNo != ''">AND t.teacher_no LIKE CONCAT('%', #{teacherNo}, '%')</if>
            <if test="status != null">AND u.status = #{status}</if>
            and u.user_type = 2 and u.is_deleted = 0 and t.is_deleted = 0
        </where>
        order by u.create_time desc
    </select>

    <select id="getCollegeIdByName" resultType="java.lang.Long">
        select id from college where name = #{collegeName} and is_deleted = 0
    </select>

    <select id="getMajorIdByNameWithCollegeId" resultType="java.lang.Long">
        select id from major where name = #{majorName} and college_id = #{collegeId} and is_deleted = 0
    </select>

    <select id="getTeacherAccountDetail" resultType="com.ccr.vo.UserWithTeacherInfoVO">
        select
            u.id,u.username,u.real_name,u.phone,u.email,u.gender,u.create_time,u.update_time,
            t.teacher_no,t.title,t.hire_date,t.status,t.college_id,t.major_id,
            c.name as collegeName,m.name as majorName
        from user u
            left join teacher t on u.id = t.user_id
            left join college c on t.college_id = c.id
            left join major m on t.major_id = m.id
        where u.id = #{id} and u.user_type = 2 and u.is_deleted = 0 and t.is_deleted = 0
    </select>

    <select id="selectById" resultType="com.ccr.entity.User">
        select id,username from user where id = #{id} and is_deleted = 0 and user_type = 2
    </select>

    <select id="exportStudentAccount" resultType="com.ccr.Excel.pojo.vo.TeacherExcelVO">
        select
            u.id,u.username,u.real_name,u.phone,u.email,u.gender,u.create_time,u.update_time,
            t.teacher_no,t.title,t.hire_date,t.status,t.college_id,t.major_id,
            c.name as collegeName,m.name as majorName
        from user u
            left join teacher t on u.id = t.user_id
            left join college c on t.college_id = c.id
            left join major m on t.major_id = m.id
        <where>
            <if test="username != null and username != ''">AND u.username LIKE CONCAT('%', #{username}, '%')</if>
            <if test="realName != null and realName != ''">AND u.real_name LIKE CONCAT('%', #{realName}, '%')</if>
            <if test="teacherNo != null and teacherNo != ''">AND t.teacher_no LIKE CONCAT('%', #{teacherNo}, '%')</if>
            <if test="status != null">AND u.status = #{status}</if>
            and u.user_type = 2 and u.is_deleted = 0 and t.is_deleted = 0
        </where>
        order by u.create_time desc
    </select>


</mapper>